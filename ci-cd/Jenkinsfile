pipeline {
  agent any
  environment {
    COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
    DOCKER_REPOSITORY = "pelegov"
    BRANCH = "main"
    FOLDER = "ci-cd/flask"
    IMAGE_NAME = "leumi"
  }
  stages {
    stage('Git pull') {
      steps {
        sh "git pull origin $BRANCH"
      }
    }
    stage('build & push & run') {
      steps {
        sh """
        cd $FOLDER
        docker build -t $DOCKER_REPOSITORY/$IMAGE_NAME:$COMMIT .
        docker push $DOCKER_REPOSITORY/$IMAGE_NAME:$COMMIT
      """
      }
    }
    stage('Run Docker Container') {
      steps {
        sh "docker run -d -p 5001:5000 $DOCKER_REPOSITORY/$IMAGE_NAME:$COMMIT"
      }
    }
  }
  post {  
    failure {  
      sh "echo Sending Failed Email!"
        emailext body: '${DEFAULT_CONTENT} - CI/CD Pipeline has been failed!',
        subject: '${DEFAULT_SUBJECT} - CI/CD pipeline failed!',
        mimeType: 'text/html',to: ''
    } 
  }
}
